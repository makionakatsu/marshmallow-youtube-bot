# Marshmallow to YouTube Bot (Chrome拡張機能)

匿名質問サービス「マシュマロ」で収集した質問をYouTube Live Chatへ自動投稿するChrome拡張機能です。

## 📋 概要

この拡張機能は、マシュマロの受信箱を監視して新着質問を自動取得し、設定された間隔でYouTube Live Chatに投稿します。自動投稿と手動投稿の切り替えが可能で、NGワードフィルタリングやリトライ機能も搭載しています。

## ✨ 主な機能

### 🔄 投稿モード
- **自動モード**: 設定した間隔で定期的に自動投稿（デフォルト2分間隔）
- **手動モード**: 手動投稿ボタンで任意のタイミングで投稿

### 📡 マシュマロ連携
- **リアルタイム監視**: マシュマロ受信箱のDOM監視で新着質問を自動取得
- **接続状況表示**: ログイン状態をリアルタイム表示
- **質問キュー管理**: 投稿待ち・投稿済み・スキップ状況を表示

### ⚙️ カスタマイズ機能
- **投稿間隔設定**: 30秒〜任意の間隔で調整可能
- **NGワードフィルタ**: 特定キーワードを含む質問を自動スキップ
- **リトライ設定**: 投稿失敗時の自動リトライ回数（1-10回）
- **質問フォーマット**: 投稿時の接頭辞をカスタマイズ可能

### 🛡️ セキュリティ
- **APIキー暗号化**: AES-GCM（256bit）で安全に保存
- **XSS防止**: 投稿内容の自動サニタイズ
- **OAuth2認証**: 安全なYouTube API アクセス

## 🚀 インストール方法

1. **ファイルのダウンロード**
   ```
   git clone [リポジトリURL]
   ```
   または、ZIPファイルをダウンロードして解凍

2. **Chrome拡張機能として読み込み**
   - Chromeで `chrome://extensions/` を開く
   - 右上の「デベロッパーモード」をONにする
   - 「パッケージ化されていない拡張機能を読み込む」をクリック
   - プロジェクトフォルダ（`manifest.json`があるフォルダ）を選択

3. **拡張機能の確認**
   - ツールバーに拡張機能アイコンが表示されることを確認

## ⚙️ 設定方法

### 1. 基本設定
1. 拡張機能ポップアップの右上⚙ボタンをクリック
2. 設定画面で各項目を設定：

**YouTube Data API v3**
- APIキーを入力（[Google Cloud Console](https://console.cloud.google.com/)で取得）

**投稿設定**
- 自動投稿間隔：デフォルト120秒、最小30秒
- 最大リトライ回数：1-10回（デフォルト3回）
- 質問接頭辞：デフォルト "Q: "

**NGワード設定**
- 1行に1つずつNGワードを入力

**その他の設定**
- テストモード：ダミー質問追加機能
- エラー通知：ブラウザ通知のON/OFF

### 2. YouTube Live設定
1. メイン画面でYouTube Live URLを入力
2. 「確定」ボタンでライブチャットIDを自動取得

### 3. マシュマロ接続
1. `https://marshmallow-qa.com/messages` にアクセス
2. マシュマロアカウントでログイン
3. 拡張機能で「マシュマロ: 接続済み」を確認

## 📖 使い方

### 基本的な流れ

1. **事前準備**
   - YouTube Data API v3キーを取得・設定
   - マシュマロにログイン
   - YouTube Live URLを設定

2. **モード選択**
   - **自動モード**: 「自動」ボタン（グレー表示）
   - **手動モード**: 「手動」ボタン（青色表示）

3. **BOT開始**
   - 「開始」ボタンをクリック
   - ステータスが「実行中」または「手動モード (待機中)」に変更

4. **動作確認**
   - 接続状況：「マシュマロ: 接続済み」
   - キュー表示で投稿状況を監視

### 🤖 自動モードの動作

- **開始後**: 設定した間隔時間後に最初の投稿
- **継続投稿**: 間隔ごとに自動的に投稿継続
- **例**: 2分間隔設定の場合
  ```
  14:00:00 開始ボタン押下
  14:02:00 最初の投稿
  14:04:00 2回目の投稿
  14:06:00 3回目の投稿...
  ```

### ✋ 手動モードの動作

- **開始後**: 自動投稿は行われない
- **投稿方法**: 「手動投稿」ボタンを押下
- **用途**: タイミングを自分で制御したい場合

### 📊 キュー管理

**投稿状況の確認**
- **pending**: 投稿待ち（黄色）
- **sent**: 投稿完了（緑色）
- **skipped**: スキップ（赤色、NGワード等）

**キュー操作**
- 「キュー表示」: 現在の投稿待ち質問を表示
- 「キュー削除」: 全ての投稿待ち質問を削除
- 個別削除: 各質問の「削除」ボタン

## 🔧 技術仕様

### プロジェクト構成
```
marshmallow2youtube/
├── manifest.json              # 拡張機能設定
├── popup.html                 # メインUI
├── popup.js                   # メインロジック
├── settings.html              # 設定画面
├── settings.js                # 設定ロジック
├── background.service_worker.js # バックグラウンド処理
├── content_script.js          # マシュマロサイト監視
├── tests/
│   └── background.test.js     # テストファイル
└── icons/                     # アイコン画像
    ├── icon16.png
    ├── icon48.png
    └── icon128.png
```

### 使用技術
- **Manifest V3**: 最新のChrome拡張機能仕様
- **Service Worker**: バックグラウンド処理
- **Web Crypto API**: APIキーの暗号化
- **Chrome APIs**: storage, alarms, identity, notifications
- **YouTube Data API v3**: ライブチャット投稿

### セキュリティ機能
- **暗号化**: AES-GCM 256bit でAPIキーを保護
- **XSS対策**: HTMLエスケープによる安全な投稿
- **OAuth2**: 安全なYouTube認証
- **最小権限**: 必要最小限のブラウザ権限

## 🐛 トラブルシューティング

### よくある問題

**「マシュマロ: 未接続」と表示される**
- マシュマロサイト（https://marshmallow-qa.com/messages）でログインしているか確認
- 拡張機能を再読み込み後、マシュマロページをリロード

**投稿が実行されない**
- YouTube Data API v3キーが正しく設定されているか確認
- ライブ配信が実際に進行中か確認
- 「APIキー診断」ボタンでAPIキーの状態を確認

**「無効なURLです」エラー**
- YouTube Live URLが正しい形式か確認
- 対応URL形式: `https://www.youtube.com/watch?v=VIDEO_ID`
- ライブ配信URLであることを確認

### マシュマロサイト変更時の対応

マシュマロのHTML構造が変更された場合、`content_script.js`の修正が必要です：

1. **開発者ツールでHTML構造を確認**
   - マシュマロ受信箱ページでF12を押下
   - Elements タブでメッセージ要素を確認

2. **セレクタの修正**
   ```javascript
   // content_script.js内の要修正箇所
   checkLoginStatus()    // ログイン判定
   extractMessages()     // メッセージ抽出
   targetNode           // DOM監視対象
   ```

3. **拡張機能の再読み込み**
   - `chrome://extensions/`で拡張機能を再読み込み

## 📝 ライセンス

[ライセンス情報を記載]

## 🤝 貢献

バグ報告や機能要望は、GitHubのIssuesでお知らせください。

---

**注意**: この拡張機能は日本語環境での使用を前提としています。マシュマロとYouTubeの利用規約に従ってご使用ください。