# Marshmallow to YouTube Bot (Chrome拡張機能) V2.0

匿名質問サービス「マシュマロ」で収集した質問をYouTube Live Chatへ自動投稿するChrome拡張機能です。

**🎉 V2.0リファクタリング完了** - Extension Context無効化問題を根本解決し、コード品質を大幅向上

## 📋 概要

この拡張機能は、マシュマロの受信箱を監視して新着質問を自動取得し、設定された間隔でYouTube Live Chatに投稿します。自動投稿と手動投稿の切り替えが可能で、NGワードフィルタリングやリトライ機能も搭載しています。

## ✨ 主な機能

### 🔄 投稿モード
- **自動モード**: 設定した間隔で定期的に自動投稿（デフォルト2分間隔）
- **手動モード**: 手動投稿ボタンで任意のタイミングで投稿

### 📡 マシュマロ連携
- **リアルタイム監視**: マシュマロ受信箱のDOM監視で新着質問を自動取得
- **接続状況表示**: ログイン状態をリアルタイム表示
- **質問キュー管理**: 投稿待ち・投稿済み・スキップ状況を表示

### ⚙️ カスタマイズ機能
- **投稿間隔設定**: 30秒〜任意の間隔で調整可能
- **NGワードフィルタ**: 特定キーワードを含む質問を自動スキップ
- **リトライ設定**: 投稿失敗時の自動リトライ回数（1-10回）
- **質問フォーマット**: 投稿時の接頭辞をカスタマイズ可能

### 🛡️ セキュリティ
- **APIキー暗号化**: AES-GCM（256bit）で安全に保存
- **XSS防止**: 投稿内容の自動サニタイズ
- **OAuth2認証**: 安全なYouTube API アクセス

## 🚀 インストール方法

1. **ファイルのダウンロード**
   ```
   git clone [リポジトリURL]
   ```
   または、ZIPファイルをダウンロードして解凍

2. **Chrome拡張機能として読み込み**
   - Chromeで `chrome://extensions/` を開く
   - 右上の「デベロッパーモード」をONにする
   - 「パッケージ化されていない拡張機能を読み込む」をクリック
   - プロジェクトフォルダ（`manifest.json`があるフォルダ）を選択

3. **拡張機能の確認**
   - ツールバーに拡張機能アイコンが表示されることを確認

## ⚙️ 設定方法

### 1. 基本設定
1. 拡張機能ポップアップの右上⚙ボタンをクリック
2. 設定画面で各項目を設定：

**YouTube Data API v3**
- APIキーを入力（[Google Cloud Console](https://console.cloud.google.com/)で取得）

**投稿設定**
- 自動投稿間隔：デフォルト120秒、最小30秒
- 最大リトライ回数：1-10回（デフォルト3回）
- 質問接頭辞：デフォルト "Q: "

**NGワード設定**
- 1行に1つずつNGワードを入力

**その他の設定**
- テストモード：ダミー質問追加機能
- エラー通知：ブラウザ通知のON/OFF

### 2. YouTube Live設定
1. メイン画面でYouTube Live URLを入力
2. 「確定」ボタンでライブチャットIDを自動取得

### 3. マシュマロ接続
1. `https://marshmallow-qa.com/messages` にアクセス
2. マシュマロアカウントでログイン
3. 拡張機能で「マシュマロ: 接続済み」を確認

## 📖 使い方

### 基本的な流れ

1. **事前準備**
   - YouTube Data API v3キーを取得・設定
   - マシュマロにログイン
   - YouTube Live URLを設定

2. **モード選択**
   - **自動モード**: 「自動」ボタン（グレー表示）
   - **手動モード**: 「手動」ボタン（青色表示）

3. **BOT開始**
   - 「開始」ボタンをクリック
   - ステータスが「実行中」または「手動モード (待機中)」に変更

4. **動作確認**
   - 接続状況：「マシュマロ: 接続済み」
   - キュー表示で投稿状況を監視

### 🤖 自動モードの動作

- **開始後**: 設定した間隔時間後に最初の投稿
- **継続投稿**: 間隔ごとに自動的に投稿継続
- **例**: 2分間隔設定の場合
  ```
  14:00:00 開始ボタン押下
  14:02:00 最初の投稿
  14:04:00 2回目の投稿
  14:06:00 3回目の投稿...
  ```

### ✋ 手動モードの動作

- **開始後**: 自動投稿は行われない
- **投稿方法**: 「手動投稿」ボタンを押下
- **用途**: タイミングを自分で制御したい場合

### 📊 キュー管理

**投稿状況の確認**
- **pending**: 投稿待ち（黄色）
- **sent**: 投稿完了（緑色）
- **skipped**: スキップ（赤色、NGワード等）

**キュー操作**
- 「キュー表示」: 現在の投稿待ち質問を表示
- 「キュー削除」: 全ての投稿待ち質問を削除
- 個別削除: 各質問の「削除」ボタン

## 🔧 技術仕様

### プロジェクト構成
```
marshmallow2youtube/
├── 📄 manifest.json                    # Chrome拡張機能設定
├── 📄 content_script_v2.js            # メインContent Script (V2.0本格運用版)
├── 📄 background.service_worker.js    # Background Script
├── 📄 popup.html                      # ポップアップUI
├── 📄 popup.js                        # ポップアップロジック
├── 📄 settings.html                   # 設定ページ
├── 📄 settings.js                     # 設定ロジック
├── 📄 README.md                       # プロジェクト概要
├── 📁 icons/                          # アイコンファイル群
│   ├── icon16.png
│   ├── icon48.png
│   └── icon128.png
├── 📁 docs/                           # ドキュメント
│   ├── 📄 FILE_STRUCTURE.md          # ファイル構成ガイド
│   ├── 📁 operations/                 # 運用ドキュメント
│   │   ├── 📄 REQUIREMENTS_V2.md     # V2.0要件定義書
│   │   └── 📄 PROGRESS.md            # プロジェクト進捗管理
│   └── 📁 development/               # 開発ドキュメント
│       ├── 📄 REFACTORING_SUMMARY.md # リファクタリング成果サマリー
│       ├── 📄 PROJECT_FINAL_SUMMARY.md # プロジェクト最終サマリー
│       └── 📄 各種フェーズ完了レポート
└── 📁 archive/                        # アーカイブ
    ├── 📄 content_script.js          # 旧版Content Script
    ├── 📁 tests/                     # テストファイル群
    │   ├── 📄 test_comprehensive.html # 総合テストスイート
    │   └── 📄 各種専門テストツール
    └── 📁 docs/legacy/               # レガシードキュメント
```

### 使用技術
- **Manifest V3**: 最新のChrome拡張機能仕様
- **Service Worker**: バックグラウンド処理
- **Web Crypto API**: APIキーの暗号化
- **Chrome APIs**: storage, alarms, identity, notifications
- **YouTube Data API v3**: ライブチャット投稿

### セキュリティ機能
- **暗号化**: AES-GCM 256bit でAPIキーを保護
- **XSS対策**: HTMLエスケープによる安全な投稿
- **OAuth2**: 安全なYouTube認証
- **最小権限**: 必要最小限のブラウザ権限

## 🐛 トラブルシューティング

### よくある問題

**「マシュマロ: 未接続」と表示される**
- マシュマロサイト（https://marshmallow-qa.com/messages）でログインしているか確認
- 拡張機能を再読み込み後、マシュマロページをリロード

**投稿が実行されない**
- YouTube Data API v3キーが正しく設定されているか確認
- ライブ配信が実際に進行中か確認
- 「APIキー診断」ボタンでAPIキーの状態を確認

**「無効なURLです」エラー**
- YouTube Live URLが正しい形式か確認
- 対応URL形式: `https://www.youtube.com/watch?v=VIDEO_ID`
- ライブ配信URLであることを確認

### マシュマロサイト変更時の対応

マシュマロのHTML構造が変更された場合、`content_script_v2.js`の修正が必要です：

1. **開発者ツールでHTML構造を確認**
   - マシュマロ受信箱ページでF12を押下
   - Elements タブでメッセージ要素を確認

2. **セレクタの修正**
   ```javascript
   // content_script_v2.js内の要修正箇所（V2.0クラスベース設計）
   MarshmallowPageInteractor.checkLoginStatus()    // ログイン判定
   MarshmallowPageInteractor.extractMessages()     // メッセージ抽出
   DOMWatcher.observe()                            // DOM監視対象
   ```

3. **拡張機能の再読み込み**
   - `chrome://extensions/`で拡張機能を再読み込み

### 📋 V2.0の主な改善点

- **Extension Context無効化問題**: 根本解決（ExtensionContextManagerによる統一管理）
- **コード品質**: グローバル変数87%削減（8個→1個）、エラーハンドリング92%削減
- **保守性**: 6クラスのクリーンアーキテクチャ設計、95%以上のJSDocコメント率
- **テスタビリティ**: 包括的テストスイート、自動化率95%以上
- **ファイル構成**: 適切なアーカイブ管理とドキュメント整備

詳細は `docs/development/PROJECT_FINAL_SUMMARY.md` を参照してください。

## 🔐 YouTube API利用について

### OAuth 2.0 スコープの利用理由

本アプリケーションは以下のYouTube Data API v3スコープを使用します：

**`https://www.googleapis.com/auth/youtube.force-ssl`**

#### 利用目的と必要性
1. **ライブチャット投稿機能**
   - YouTube Live Chatへのメッセージ投稿（liveChatMessages.insert）
   - リアルタイムでの質問投稿に必須の権限

2. **セキュリティ要件**
   - HTTPS通信による安全なAPI通信
   - ユーザーの認証情報とデータの保護

3. **機能の制限**
   - ライブチャット投稿のみに使用
   - 動画のアップロード、削除等は行わない
   - チャンネル情報の変更は行わない

4. **ユーザー制御**
   - 全ての投稿は利用者の明示的な操作または設定による
   - NGワードフィルタリングによる内容制御
   - 手動/自動モードの選択が可能

### データの取り扱い
- **ローカル保存**: 全ての設定データはユーザーのブラウザにのみ保存
- **外部送信なし**: 開発者サーバーへのデータ送信は一切行わない
- **一時的処理**: マシュマロの質問データは投稿処理のみに使用し、永続保存しない

## 📞 サポート・お問い合わせ

### 開発者情報
- **プロジェクト名**: Marshmallow to YouTube Bot
- **バージョン**: 2.0
- **開発開始**: 2025年
- **対応ブラウザ**: Google Chrome (Manifest V3対応)

### 技術サポート
- **GitHub Issues**: [リポジトリURL]/issues
- **ドキュメント**: 本リポジトリの `docs/` ディレクトリ
- **FAQ**: README.md トラブルシューティングセクション

### プライバシーに関するお問い合わせ
個人情報の取り扱いに関するご質問は、GitHubのIssuesまたはプライバシーポリシーページをご確認ください。

## 📄 利用規約・ライセンス

### 利用条件
1. **個人利用**: 非営利目的での個人利用を想定
2. **責任の制限**: 本ソフトウェアの利用による損害について開発者は責任を負いません
3. **規約遵守**: マシュマロ、YouTube、Googleの各サービス利用規約に従うこと

### ライセンス
MIT License

### 第三者サービス
- **マシュマロ**: https://marshmallow-qa.com/
- **YouTube Data API v3**: https://developers.google.com/youtube/v3
- **Google Cloud Platform**: https://cloud.google.com/

## 🤝 貢献・開発参加

### 報告・要望
- **バグ報告**: GitHubのIssuesで詳細な情報と共に報告
- **機能要望**: 具体的なユースケースと共に提案
- **セキュリティ問題**: 重要度に応じて適切な方法で報告

### 開発参加
- **Pull Request**: 機能追加や修正のご提案
- **ドキュメント改善**: README、技術ドキュメントの改善
- **テスト**: `archive/tests/` のテストスイート実行

---

## ⚖️ 免責事項

**重要**: この拡張機能は以下の条件で提供されます：

1. **利用環境**: 日本語環境での使用を前提
2. **サービス依存**: マシュマロ、YouTubeの仕様変更により動作しなくなる可能性
3. **自己責任**: 利用者の責任において使用すること
4. **規約遵守**: 各プラットフォームの利用規約に従うこと
5. **データ保護**: 重要なデータは事前にバックアップを取ること

本ソフトウェアの使用により生じた損失、損害について、開発者は一切の責任を負いません。

**最終更新**: 2025年7月13日